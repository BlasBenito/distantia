---
title: "Comparison old and new versions: old version"
author: "Blas M. Benito"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Installing old package version

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}
library(here)
Rcpp::compileAttributes(here::here())
devtools::document()
devtools::install()
library(distantia)
```

#Preparing comparison data

```{r}
data(sequenceA)
data(sequenceB)

sequences <- prepareSequences(
  sequence.A = sequenceA,
  sequence.B = sequenceB,
  merge.mode = "overlap",
  if.empty.cases = "omit",
  transformation = "hellinger"
)

a <- sequences |> 
  dplyr::filter(
    id == "A"
  ) |> 
  dplyr::select(-id) |> 
  as.matrix()

b <- sequences |> 
  dplyr::filter(
    id == "B"
  ) |> 
  dplyr::select(-id) |> 
  as.matrix()
```


# Comparison

## Distance matrix

```{r}
dist_matrix <- distance_matrix_cpp(
  a,
  b,
  method = "euclidean"
)
dist_matrix[1:5, 1:5]
dist_matrix[45:49, 28:32]
```

## Cost matrix

```{r}
cost_matrix <- cost_matrix_cpp(
  dist_matrix = dist_matrix
)
cost_matrix[1:5, 1:5]
cost_matrix[45:49, 28:32]
```

## Cost path


### Orthogonal

```{r}
#extracting least-cost path
path <- cost_path_cpp(
  dist_matrix = dist_matrix,
  cost_matrix = cost_matrix
  )

nrow(path)
path
sum(path$dist)
sum(path$cost)
```


### Diagonal

```{r}
#extracting least-cost path
path_diagonal <- cost_path_diag_cpp(
  dist_matrix = dist_matrix,
  cost_matrix = cost_matrix
  )

nrow(path_diagonal)
path_diagonal
sum(path_diagonal$dist)
sum(path_diagonal$cost)
```

## Remove blocks

This version is better than the older one.




```{r}
path_no_blocks <- cost_path_trim_cpp(
    path = path
    )
nrow(path_no_blocks)
sum(path_no_blocks$dist)
sum(path_no_blocks$cost)
path_no_blocks |> 
  dplyr::arrange(a, b)
```
```{r}
plotMatrix(
  distance.matrix = dist_matrix,
  least.cost.path = path_no_blocks
)
```

## Cost sum

### No blocks path

Small difference here:
old version: 6.217325 because it omits one data point
new version: 6.736756 this is the rigth value

```{r}
cost_sum <- cost_path_sum_cpp(
  path = path_no_blocks
  )
cost_sum
```
### Full path

Both versions are identical here

```{r}
cost_sum <- cost_path_sum_cpp(
  path = path
  )
cost_sum
```

## Autosum

### No blocks path

Important difference here:
old version: 7.009
new version: 15.11319

```{r}
sequence_sum <- auto_sum_path_cpp(
  a,
  b,
  path_no_blocks,
  method = "euclidean"
  )
sequence_sum
```
### Full path

Both versions return identical results

```{r}
sequence_sum <- auto_sum_no_path_cpp(
  a,
  b,
  method = "euclidean"
  )
sequence_sum
```

## Psi

There is something very wrong here, as the result should be 2.07

```{r}
old_cost_sum
cost_sum
old_sequence_sum
sequence_sum

((old_cost_sum[[1]] * 2) - old_sequence_sum[[1]]) / old_sequence_sum[[1]]

((cost_sum * 2) - sequence_sum) / sequence_sum
```


```{r}
dissimilarity <- psi_full_cpp(
  a, b, "euclidean", FALSE, FALSE, FALSE
  )
dissimilarity
```

## Complete psi computation

```{r}
dissimilarity <- workflowPsi(
  sequences = sequences,
  grouping.column = "id",
  method = "euclidean",
  format = "list",
  diagonal = FALSE,
  ignore.blocks = TRUE
)
dissimilarity[[1]]
```
## P-value

```{r}
p_value <- workflowNullPsi(
  sequences = sequences,
  grouping.column = "id",
  method = "euclidean",
  diagonal = FALSE,
  ignore.blocks = TRUE,
  repetitions = 99,
  parallel.execution = TRUE
)
```

### Distribution

```{r}
p_value$psi[1, ]
```
### P-value

```{r}
p_value$p[["p"]]
```

## Importance

```{r}
importance <- workflowImportance(
  sequences = sequences,
  grouping.column = "id",
  method = "euclidean",
  diagonal = FALSE,
  ignore.blocks = TRUE
  )

importance$psi

importance$psi.drop
```

