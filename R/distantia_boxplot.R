#' Boxplot of Dissimilarity Analysis Data Frames
#'
#' @description
#'
#' This function generates a visual summary of the dissimilarity or importance scores generated by the functions [distantia()] and [distantia_importance()].
#'
#' \itemize{
#'   \item [distantia()] data frame: plots the distribution of the Psi values of each time series against all others. This facilitates the identification of time series that are more or less similar to all others.
#'   \item [distantia_importance()] data frame: plots the importance (contribution to similarity/dissimilarity) of each variable across all time series, facilitating the identification of variables making time series more or less similar.
#'
#' }
#'
#' In any case, if the argument `df` contains more than one combination of input parameters, then [distantia_aggregate()] is used to summarize dissimilarity scores across groups.
#'
#' @param df (required, data frame) output of [distantia()] or [distantia_importance()]. Default: NULL
#' @param color (optional, character vector) boxplot fill color. Default: NULL
#' @param f (optional, function) function used to arrange the boxes. Can be one of `mean`, `median`, `min`, `max`, or `quantile`. Default: `median`.
#' @param ... (optional, additional arguments to `f`). If `f` is `quantile`, additional arguments such as `probs = 0.75` can be used. Default: ...
#' @param text_cex (optional, numeric) Multiplier of the text size. Default: 1
#'
#' @return boxplot
#' @export
#' @autoglobal
#' @examples
#' #three time series
#' #climate and ndvi in Fagus sylvatica stands
#' #in Spain, Germany, and Sweden
#' #centerd and scaled with global parameters
#' tsl <- tsl_initialize(
#'   x = fagus_dynamics,
#'   name_column = "name",
#'   time_column = "time"
#' ) |>
#'   tsl_transform(
#'     f = f_scale_global
#'   )
#'
#' if(interactive()){
#'   tsl_plot(
#'     tsl = tsl,
#'     guide_columns = 3
#'     )
#' }
#'
#' # example with distantia()
#' #-----------------------------------
#' distantia_df <- distantia(
#'   tsl = tsl
#' )
#'
#' if(interactive()){
#'   boxplot_stats <- distantia_boxplot(
#'     df = distantia_df
#'     )
#'     boxplot_stats
#' }
#'
#' #The boxplot identifies Spain
#' #as the site most dissimilar to all others,
#' #and Germany as the most similar to all others.
#'
#'
#' #example with distantia_importance()
#' #-----------------------------------
#' importance_df <- distantia_importance(
#'   tsl = tsl
#' )
#'
#' if(interactive()){
#'   boxplot_stats <- distantia_boxplot(
#'     df = distantia_df
#'     )
#' }
#'
#' #the boxplot identifies the variable evi
#' #(enhanced vegetation index) as the one
#' #contributing the most to site dissimilarity,
#' #and termpature as the variable contributing
#' #the most to site similarity.
#' @family dissimilarity_analysis
distantia_boxplot <- function(
    df = NULL,
    color = NULL,
    f = median,
    ...,
    text_cex = 1
){

  old_par <- graphics::par(no.readonly = TRUE)
  on.exit(graphics::par(old_par))

  df_type <- attributes(df)$type

  types <- c(
    "distantia_df",
    "distantia_importance_df"
  )

  if(!(df_type %in% types)){
    stop("distantia::distantia_boxplot(): argument 'df' must be the output of distantia::distantia() or distantia::distantia_importance()", call. = FALSE)
  }

  #aggregate df if needed
  df_list <- utils_distantia_df_split(
    df = df
  )

  if(length(df_list) > 1){

    message(
      "distantia::distantia_boxplot(): There are ",
      length(df_list),
      "  combinations of arguments in 'df'. Applying distantia_aggregate(..., f = mean) to combine them into a single one."
    )

    df <- distantia_aggregate(
      df = df,
      f = mean
    )

    rm(df_list)

  }

  #prepare df for boxplot
  if(df_type == "distantia_df"){

    variable <- c(df$x, df$y)
    value <- c(df$psi, df$psi)
    xlab <- "Dissimilarity (Psi)"
    ylab <- ""
    main <- "Overall Dissimilarity"

  }

  if(df_type == "distantia_importance_df"){

      variable <- df$variable
      value <- df$importance
      xlab <- "Importance (Psi %)"
      ylab <- ""
      main <- "Variable Contribution to \n Similarity (<0) and Dissimilarity (>0)"

  }


  if(is.null(color)){

    color <- grDevices::hcl.colors(
      n = length(unique(variable)),
      palette = "Zissou 1"
    )

  }

  df_plot <- data.frame(
    variable = variable,
    value = value
  )

  #order by median
  variable_means <- tapply(
    X = df_plot$value,
    INDEX = df_plot$variable,
    FUN = f,
    ... = ...
    )

  variable_order <- sort(
    variable_means,
    decreasing = FALSE
  ) |>
    names()

  df_plot$variable <- factor(
    x = df_plot$variable,
    levels = variable_order
    )

  #notch or not
  notch <- {
    if(
      min(table(df_plot$variable)) > 30
    ){
      TRUE
    } else {
      FALSE
    }
  }

  graphics::par(
    mar=c(5, 8, 4, 2),
    las = 1,
    cex.main = 0.8 * text_cex,
    cex.lab = 0.8 * text_cex,
    cex.axis = 0.7 * text_cex
    )

  graphics::boxplot(
    formula = value ~ variable,
    data = df_plot,
    xlab = xlab,
    ylab = ylab,
    horizontal = TRUE,
    notch = notch,
    col = color,
    main = main
  )

  if(df_type == "distantia_importance_df"){
    graphics::abline(
      v = 0,
      col = "gray50",
      lwd = 2
      )
  }

}
