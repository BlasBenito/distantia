---
output: github_document
always_allow_html: true
---

# distantia: Time Series Dissimilarity Analysis with Dynamic Time Warping

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  eval = TRUE
)
```

<!-- badges: start -->

[![DOI](https://zenodo.org/badge/187805264.svg)](https://zenodo.org/badge/latestdoi/187805264)
[![CRAN\_Release\_Badge](http://www.r-pkg.org/badges/version/distantia)](https://CRAN.R-project.org/package=distantia)
[![CRAN\_Download\_Badge](http://cranlogs.r-pkg.org/badges/grand-total/distantia)](https://CRAN.R-project.org/package=distantia)
[![R-CMD-check](https://github.com/BlasBenito/distantia/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/BlasBenito/distantia/actions/workflows/R-CMD-check.yaml)


<!-- badges: end -->

## Warning

Version 2.0.0 of `distantia` is a full re-write from scratch and **will break existing workflows**. Please refer to the [Changelog](https://blasbenito.github.io/distantia/news/index.html) for details before updating.

## Summary

The `distantia` package has undergone a major overhaul to enhance performance and usability. Core functions are now implemented in C++ for faster execution and improved memory efficiency, with streamlined R wrappers to simplify user interaction. 

Function and argument names have been updated to offer a more intuitive experience. Additionally, most time series operations are now powered by the [zoo](https://cran.r-project.org/web/packages/zoo/index.html) library to provide a consistent and efficient data handling.

Version 2.0 introduces "time series lists" (`tsl`), which are lists of zoo objects. A comprehensive suite of functions named `tsl_...()` have been added to the pacakge to generate, resample, transform, analyze, and visualize univariate, multivariate, regular, or irregular time series. Many of these functions support a parallelized execution via the [future](https://future.futureverse.org/) package, and progress bars as provided by the package [progressr](https://progressr.futureverse.org/).

Finally, to further aid learning and experimentation, new example datasets from different disicplines and tools to simulate time series are also included.

## Citation

If you find this package useful, please cite it as:

*Blas M. Benito, H. John B. Birks (2020). distantia: an open-source toolset to quantify dissimilarity between multivariate ecological time-series. Ecography, 43(5), 660-667. doi: [10.1111/ecog.04895](https://nsojournals.onlinelibrary.wiley.com/doi/10.1111/ecog.04895).*

*Blas M. Benito (2024). distantia: A Toolset for Time Series Dissimilarity Analysis. R package version 2.0.0. url:  [https://blasbenito.github.io/distantia/](https://blasbenito.github.io/distantia/).*

## Main Improvements in Version 2.0.0

1. **High computational speed**: The logics for the time series dissimilarity analysis provided by `distantia()` and `distantia_importance()` are now implemented in a C++ backend designed for speed. This new feature, combined with a parallelization setup provided by the [future](https://future.futureverse.org/) makes dissimilarity analysis for large datasets blazing fast.
2. **Usage of zoo objects**: Individual time series in distantia are now [zoo](https://cran.r-project.org/package=zoo) objects, which support regular and irregular time series with various index types (e.g., Date, POSIXct), enable efficient handling and manipulation, and offer robust tools for alignment, merging, and filling missing values.
3. **Time Series Lists and associated toolset**: Groups of time series to compare are stored in Time Series Lists (TSL), which are lists of zoo objects. The package also comes with a complete toolset to create, manage, transform, aggregate, and visualize TSLs, with the objective of providing a smooth user experience.

## Install

The package `distantia` can be installed from CRAN.

```{r, eval = FALSE}
install.packages("distantia")
```


The development version can be installed from GitHub.

```{r, eval = FALSE}
remotes::install_github(
  repo = "blasbenito/distantia", 
  ref = "main"
  )
```


Previous versions are in the “archive_xxx” branches of the GitHub repository.

```{r, eval = FALSE}
remotes::install_github(
  repo = "blasbenito/distantia", 
  ref = "archive_v1.0.2"
  )
```

## Getting Started

This section provides a minimal example on how to use `distantia`. Please, check the **Articles** section for further details.

### Setup

The code below loads the required packages, and defines a parallelization backend.

```{r packages, message = FALSE, warning = FALSE}
#required packages
library(distantia)
library(future)
library(parallelly)
library(tmap)

#parallelization setup
future::plan(
  future::multisession,
  workers = parallelly::availableCores() - 1
  )

#progress bar (does not work in Rmarkdown)
#progressr::handlers(global = TRUE)
```

### Example data

The data frame `fagus_dynamics` contains time series of enhanced vegetation index, rainfall, and temperature on stands of *Fagus sylvatica* in three countries.

```{r}
#load example data
data(
  fagus_dynamics,
  fagus_coordiantes 
  )

head(fagus_dynamics)
```

The sf data frame `fagus_coordinates` contains the site coordinates.

```{r}
fagus_coordinates
```
### Converting to TSL

The function `tsl_initialize()` transforms the target data frame into a time series list, which is a list of zoo objects.

```{r}
tsl <- tsl_initialize(
  x = fagus_dynamics,
  name_column = "name",
  time_column = "time"
)

lapply(tsl, class)
```
A quick visualization of the TSL shows that the variables are in different scales:

```{r}
tsl_plot(
  tsl = tsl,
  guide_columns = 3
)
```
The function `tsl_transform()` helps apply common transformations to all zoo time series in a TSL. Please note that the function `f_scale` uses the global mean and standard deviation across all time series to perform the scaling.

```{r}
tsl <- tsl_transform(
  tsl = tsl,
  f = f_scale
)

tsl_plot(
  tsl = tsl,
  guide_columns = 3
)
```
### Dissimilarity Analysis

The function `distantia()` computes the dissimilarity between pairs of time series using dynamic time warping. Higher values indicate higher dissimilarity.

```{r}
df <- distantia(
  tsl = tsl
)

df[, c("x", "y", "psi")]
```
```{r}
distantia_boxplot(df = df)
```


## Getting help

If you encounter bugs or issues with the documentation, please [file a issue on GitHub](https://github.com/BlasBenito/distantia/issues).
